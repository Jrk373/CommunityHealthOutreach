---
title: "Community Health Outreach"
subtitle: ""
author: 
  name: "John Ryan Kivela, MA"
  email: "Ryan.Kivela@narbha.org"
  affiliation: "The Alliance ACO"
date: today
date-format: long
format:
  html:
    theme: pulse
    embed-resources: true
    toc: true
    toc-depth: 6
    code-fold: true
    footnotes-hover: true
---

This document provides the data framework for the Community Health Outreach project. The core datasets used in that evaluation are collected through the code herein. 

# Method

## r Setup

```{r}
#| label: Setup
#| eval: true
#| include: false
#| echo: false
#| warning: false
#| error: false

## Load Libraries
library(tidyverse)
library(readxl)
library(odbc)
library(stringr)

# Set up ODBC Connection
# QRPTP01 <- DBI::dbConnect(odbc::odbc(),"AllianceData")

# adjust to allow viewing of more columns
options(width = 999)
```

## Common Objects

```{r}
# Create table for inline code
InLineCode <- data.frame(
  Column1 = "text")

# Vector of Alliance Provider Name
Provider_ShortName <- (c("CBI", "CPIH", "EHS", "LCBHC", "MMHC", "SHG", "SBH", "TGC", "WYGC"))

# Vector of NAZ Counties
NAZ_Counties <- (c("Apache", "Coconino", "Mohave", "Navajo", "Yavapai"))

```

## Procedure

### Create an indicator for if on VBPQR

```{r}

VBPQR_filtered <-
  VBPQR_AllRecords |> 
  select(
    ClaimsAdjudicatedThrough,
    AllianceProviderTIN,
    ProviderShortname,
    MemberID,
    MeasureID,
    GapStatus
  ) |> 
  rename("AHCCCSID" = MemberID) |> 
  filter(MeasureID != "HDO")

# Step 1: Filter for only the most recent ClaimsAdjudicatedThrough date
VBPQR_filtered <- VBPQR_filtered |>
  group_by(AHCCCSID) |>
  filter(ClaimsAdjudicatedThrough == max(ClaimsAdjudicatedThrough))

# Step 2: Create new columns "AMM", "FUH", and "FUM"
VBPQR_filtered <- VBPQR_filtered |>
  mutate(AMM = NA, FUH = NA, FUM = NA)

# Step 3: Update new columns based on MeasureID
VBPQR_filtered$AMM[VBPQR_filtered$MeasureID == "AMM"] <- VBPQR_filtered$GapStatus[VBPQR_filtered$MeasureID == "AMM"]
VBPQR_filtered$FUH[VBPQR_filtered$MeasureID == "FUH"] <- VBPQR_filtered$GapStatus[VBPQR_filtered$MeasureID == "FUH"]
VBPQR_filtered$FUM[VBPQR_filtered$MeasureID == "FUM"] <- VBPQR_filtered$GapStatus[VBPQR_filtered$MeasureID == "FUM"]

# Collapse data to one row per AHCCCSID
collapsed_data <- VBPQR_filtered |>
  group_by(AHCCCSID) |>
  summarize(
    AMM = max(AMM, na.rm = TRUE),
    FUH = max(FUH, na.rm = TRUE),
    FUM = max(FUM, na.rm = TRUE)
  )

# Attach VBP data to enrollment data
Analysis <-
  merge(x = AllianceEnrolledMembers,
        y = collapsed_data,
        by = "AHCCCSID",
        all.x = TRUE)

```


```{r}
# Select variables to analyze from the claims data
Claims_filtered <-
  Claims_AllHCA |> 
  select(
    Icnno,
    PrimaryID,
    AHCCCSID,
    Age,
    Age_Group,
    Population,
    RA,
    Svccode,
    BegDate,
    PrimaryDiagnosis,
    ProviderName,
    Fedtaxid,
    RenderingProviderNpi,
    PayContract,
    Placesvc,
    ProviderType,
    Dx1, Dx2, DX3, Dx4, Dx5, DX6,
    Dx7, Dx8, DX9, Dx10, Dx11, DX12,
    Calcnetpd,
    MemberACCGSA,
    MemberServiceArea,
    MemberZipcode,
    RenderingProviderServiceArea,
    MedicationName,
    MedicationGPI,
    MedicationNDC,
    EncounterStatus,
    EncounterStatusDate
  )

# Filter for Alliance Members Only
Claims_AllAlliance <-
  Claims_filtered |> 
  filter(AHCCCSID %in% AllianceEnrolledMembers$AHCCCSID)

# merge the claims data with the enrollment data
Analysis <-
  merge(x = Claims_AllAlliance,
        y = Analysis,
        by = "AHCCCSID",
        all = TRUE)

# Filter for only adjudicated paid claims
Analysis <- 
  Analysis |> 
  filter(EncounterStatus == "AP")

# Remove some extra variables that we don't need right now
Analysis <- 
  Analysis [, -c(6, 14, 30, 31, 33, 35, 36, 37, 38, 40, 44, 49, 51)]

# Remove any rogues spaces in any field in the data
Analysis <- Analysis |> 
  mutate_all(str_squish)

# Indicaters for services by the HH or not by the HH
Analysis <-
  Analysis |> 
  mutate(SvcByAssignedBHHTIN = if_else(BHHProvider_TIN == Fedtaxid, 1, 0)) |> 
  mutate(SvcByOtherTIN = if_else(BHHProvider_TIN != Fedtaxid, 1, 0))

write.csv(Analysis, "./data/output/CHO_AllianceEnrolledMembers.csv")

# check <-
#   Analysis |>
#   select(
#     AHCCCSID,
#     BHHProvider_TIN,
#     RA,
#     Fedtaxid,
#     ProviderName,
#     SvcByAssignedBHHTIN,
#     SvcByOtherTIN
#   )

```

